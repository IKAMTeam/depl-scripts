Instructions apply to the new instances of Amazon Linux 2 AMI 

We use AWS Linux 2 Extras Library to install some components. 

I. GENERAL APP SERVER CONFIGURATION

1. Set time zone: 
sudo ln -sf /usr/share/zoneinfo/US/Eastern /etc/localtime 

2. Install Corretto 11 - AWS build of Java 11 compatible with Java SE:
sudo amazon-linux-extras install java-openjdk11 

3. Install OneVizion deployment and upgrade scripts from GitHub
sudo yum install git 
git clone https://github.com/IKAMTeam/depl-scripts 
cd depl-scripts 
chmod +x *.sh 
cp credentials.conf.template credentials.conf 

4. Open credentials.conf and set variables: 
RELEASES_REPO_URL="https://ci.onevizion.com/archiva/repository/releases" 
SNAPSHOT_REPO_URL= "https://ci.onevizion.com/archiva/repository/snapshots" 
REPOSITORY_UN= "username for ci.onevizion.com access" 
REPOSITORY_PWD="password for ci.onevizion.com access" 

5. Test database connection: 
java -jar setup/test-jdbc.jar <username> <password> <host>:<port>:<sid> 


6. Install libsigar - library used in report-scheduler to monitor free RAM 
sudo cp setup/libsigar-amd64-linux.so /usr/lib

7. Add rules for sudo into /etc/sudoers for integration-scheduler:
integration-scheduler ALL=(ALL) NOPASSWD:ALL 

8. Install OneVizion services:
./install-daemon-service.sh <website> <service: services|integration-scheduler|report-scheduler|rule-service|mail-service|trackor-mail> <version> <service parameters>

- Use OneVizion install domain name for "website", i.e. "test.onevizion.com"

Supported services with list of arguments:
- services <owner_schema> <user_schema> <rpt_schema> [services_to_run: mail_service,trackor_mail,report_scheduler,rule_service]
- integration-scheduler <owner_schema> 
- report-scheduler <owner_schema> <user_schema> <rpt_schema> [report_scheduler_name]
- rule-service <owner_schema> <user_schema> [report_service_name]
- mail-service <owner_schema> [mail_service_name]
- trackor-mail <owner_schema> <user_schema>

Format for all *_schema parameters is:
USER/PASSWORD@HOST:PORT:SID (Example: prod01/password@localhost:1521:xe) 

At a minimum, "services" and "integration-scheduler" should be installed. "services" includes report-scheduler, rule-service, mail-service, trackor-mail.

Service will be installed as <website>_<service> into /opt directory:
./install-daemon-service.sh test.onevizion.com services 19.22.0 prod01/password@url:1521:a1 prod01_user/password@url:1521:a1 prod01_rpt/password@url:1521:a1
./install-daemon-service.sh test.onevizion.com integration-scheduler 19.22.0 prod01/password@url:1521:a1


9. Start services:
systemctl start <website>_<service>

Make sure that log file /opt/<website>_<service>/run.out has no errors after service start. 

10. Install syncs3: 
./install-cron-service.sh <website> syncs3 <version> "<schedule>" <owner_schema> 

Where: 
<schedule> - cron format schedule, for example: 0 3 * * * 
<owner_schema> - Credentials for OWNER schema: USER/PASSWORD@HOST:PORT:SID (Example: prod01/password@localhost:1521:xe) 

12. Test syncs3 by execution command:
sudo -u syncs3 /opt/<website>_syncs3/cron-launcher.sh 

Make sure that logs file /opt/<website>_syncs3/run.out contains no errors after complete the previous command. 



II. INSTALLING ADDITIONAL SERVICES

For each not default service in SERVICE and V_REPORT_SCHEDULER tables, a dedicated Linux daemon should be installed. Use additional --suffix parameter for install-daemon-service.sh and provide the value of SERVICE.NAME or V_REPORT_SCHEDULER.NAME as the last parameter to the install-daemon-service.sh

13 report-scheduler example (V_REPORT_SCHEDULER.NAME=service2):
./install-daemon-service.sh test.onevizion.com report-scheduler --suffix service2 19.22.0 prod01/password@url:1521:a1 prod01_user/password@url:1521:a1 prod01_rpt/password@url:1521:a1 service2


14 rule-service example (SERVICE.NAME=HTTP-Rules):
./install-daemon-service.sh test.onevizion.com rule-service --suffix HTTP-Rules 19.22.0 prod01/password@url:1521:a1 prod01_user/password@url:1521:a1 HTTP-Rules

15 mail-service example (SERVICE.NAME=alt-mail):
./install-daemon-service.sh test.onevizion.com mail-service --suffix alt-mail 19.22.0 prod01/password@url:1521:a1 alt-mail

III. LIST AND STATUS OF ONEVIZION SERVICES

16. to get list of installed services, versions and statuses run:
./list-services.sh